<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Stock Storyteller</title>
  <meta name="description" content="Type a ticker. Get a crisp, factual stock narrative with context, positives, and risks." />
  <meta name="theme-color" content="#0b0d10" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7f9fc" media="(prefers-color-scheme: light)">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0d10; --text:#e8edf3; --muted:#9aa4b2; --card:#0f1216; --border:#161b22;
      --accent:#77ffd2; --accent-2:#7aa8ff; --ring:rgba(119,255,210,.45);
      --shadow: 0 20px 60px rgba(0,0,0,.35); --glass: rgba(255,255,255,.04);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7f9fc; --text:#0b0d10; --muted:#667085; --card:#ffffff; --border:#e6eaf0;
        --shadow: 0 20px 60px rgba(0,0,0,.10); --glass: rgba(255,255,255,.6); --ring: rgba(122,168,255,.35); }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 10% -20%, rgba(122,168,255,.12), transparent 45%),
                       radial-gradient(1000px 700px at 110% 10%, rgba(119,255,210,.10), transparent 50%),
                       var(--bg);
      color:var(--text); font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:980px;margin:0 auto;padding:28px 16px 96px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:26px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{ width:42px;height:42px;border-radius:12px; background: conic-gradient(from 140deg at 50% 50%, var(--accent), var(--accent-2), var(--accent)); display:grid;place-items:center; box-shadow: var(--shadow); transform: translateZ(0); transition: transform .18s ease; }
    .logo:hover{ transform: translateY(-2px) scale(1.02) }
    .logo svg{ filter: drop-shadow(0 2px 8px rgba(0,0,0,.25)) }
    h1{font-size:22px;line-height:1.15;margin:0}
    .tagline{color:var(--muted);font-size:14px;margin-top:2px}

    .card{ position:relative; border:1px solid var(--border); border-radius:20px; padding:20px; background: color-mix(in oklab, var(--card) 88%, transparent); box-shadow: var(--shadow); backdrop-filter: saturate(140%) blur(8px); }
    @supports not (backdrop-filter: blur(8px)){ .card{ background:var(--card) } }

    .grid{display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:end}
    @media (max-width:720px){ .grid{ grid-template-columns: 1fr } }

    .field{position:relative}
    .input{ width:100%; padding:16px 14px 14px 14px; border-radius:14px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); color:var(--text); outline:0; font-size:16px; transition: box-shadow .15s ease, border-color .15s ease, transform .04s ease; }
    .input:focus{ box-shadow: 0 0 0 6px var(--ring); border-color: color-mix(in oklab, var(--accent-2) 40%, transparent) }
    .input::placeholder{ color: color-mix(in oklab, var(--muted) 70%, transparent) }
    .floating{ pointer-events:none; position:absolute; left:12px; top:12px; padding:0 6px; background:var(--card); color:var(--muted); font-size:12px; opacity:.0; transform: translateY(8px); transition: .15s ease; }
    .input:focus + .floating, .input:not(:placeholder-shown) + .floating{ opacity:1; transform: translateY(-8px); }

    .select, button{ border:1px solid var(--border); background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#03150f; font-weight:700; padding:12px 14px; border-radius:14px; cursor:pointer; font-size:15px; transition: transform .08s ease, filter .2s ease; }
    button{ display:inline-flex; align-items:center; gap:8px }
    button:active{ transform: translateY(1px) scale(.995) }
    .ghost{ background:transparent; color:var(--text); border-color:var(--border); }

    .muted{ color:var(--muted) } .helper{ margin-top:8px; font-size:12px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; border:1px solid var(--border); padding:2px 6px; border-radius:8px; font-size:12px; color:var(--muted) }

    .result{ margin-top:18px } .title{ font-size:20px; margin:0 0 6px 0 }
    .meta{ color:var(--muted); font-size:13px; margin-bottom:8px }
    .tldr{ font-style:italic; margin:10px 0 14px }
    .list h3{ font-size:13px; margin:18px 0 8px 0; letter-spacing:.2px; text-transform:uppercase; color:var(--muted) }
    ul{ margin:0; padding-left:18px }
    .tags{ margin-top:14px } .tag{ display:inline-block; margin:6px 6px 0 0; padding:6px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px; color:var(--muted) }

    .skeleton{ position:relative; height:190px; border-radius:16px; border:1px solid var(--border); background:var(--glass); overflow:hidden; }
    .skeleton::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.07), transparent); animation: shimmer 1.2s infinite; background-size:200% 100%; }
    @keyframes shimmer{ 0%{ background-position:-200% 0 } 100%{ background-position:200% 0 } }

    .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#11151a; color:#fff; padding:12px 14px; border-radius:12px; border:1px solid #2a2f37; box-shadow:var(--shadow); font-size:14px; display:none; z-index:1000 }

    .footer{ margin-top:34px; text-align:center; color:var(--muted); font-size:12px }
    .sep{ height:1px; background:var(--border); margin:16px 0 }
    @media (prefers-reduced-motion: reduce){ *{ animation: none !important; transition: none !important } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 16l6-7 4 5 8-10" stroke="#00130a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h1>AI Stock Storyteller</h1>
          <div class="tagline">Minimal UI. Maximum signal.</div>
        </div>
      </div>
      <div class="row">
        <span class="kbd">⌘/Ctrl</span><span class="kbd">K</span><span class="muted"> to focus</span>
      </div>
    </header>

    <section class="card">
      <div class="grid" role="search">
        <div class="field">
          <input id="ticker" class="input" placeholder=" " autocomplete="off" spellcheck="false" aria-label="Ticker input (e.g., AAPL)" />
          <label class="floating" for="ticker">Ticker (e.g., AAPL, MSFT, NVDA)</label>
        </div>
        <select id="window" class="select" aria-label="Window">
          <option value="90">Last 90 days</option>
          <option value="180" selected>Last 180 days</option>
          <option value="365">Last 365 days</option>
        </select>
        <button id="go" aria-label="Tell the story">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 12h14M13 5l7 7-7 7" stroke="#03150f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Tell the story
        </button>
      </div>
      <div class="row helper">
        <span class="muted">Tip: Try <b>AAPL</b> or <b>NVDA</b>. Data may be delayed ~15m.</span>
        <span class="muted">|</span>
        <button id="share" class="ghost" aria-label="Share current link">Share</button>
        <button id="copy" class="ghost" aria-label="Copy link">Copy link</button>
      </div>

      <div id="stage" class="result" aria-live="polite" aria-busy="false"></div>
    </section>

    <div class="footer">
      <div class="sep"></div>
      Built with FastAPI · AWS Lambda · API Gateway · OpenAI · yfinance
      <div class="muted" style="margin-top:6px">Educational use only. Not investment advice.</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

  <script>
    // ======= SET THIS AFTER BACKEND DEPLOY =======
    // Example (us-west-2):
    // "https://abcd1234.execute-api.us-west-2.amazonaws.com/Prod/api"
    const API_BASE = "https://hzvhm120y9.execute-api.us-west-2.amazonaws.com/Prod/api";


    const $ = sel => document.querySelector(sel);
    const stage = $('#stage');
    const toast = $('#toast');
    const fmtNum = n => new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(+n || 0);

    function showToast(msg){
      toast.textContent = msg; toast.style.display='block';
      clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.style.display='none', 2500);
    }
    function setLoading(on){
      stage.setAttribute('aria-busy', on ? 'true' : 'false');
      stage.innerHTML = on ? `<div class="skeleton" aria-hidden="true"></div>` : '';
    }
    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[s]));
    }
    function getParams(){
      const t = ($('#ticker').value || '').trim().toUpperCase();
      const w = $('#window').value;
      return {t, w};
    }
    function updateURL(t, w){
      const url = new URL(location.href);
      url.searchParams.set('t', t);
      url.searchParams.set('w', w);
      history.replaceState(null, '', url.toString());
    }

    async function run(){
      const {t, w} = getParams();
      if(!t){ showToast('Please enter a ticker'); $('#ticker').focus(); return; }
      if(!API_BASE || API_BASE.includes('YOUR_API_URL')){ showToast('Set API_BASE in the HTML first.'); return; }

      try{ localStorage.setItem('last_ticker', t); }catch(_){}
      updateURL(t, w);
      setLoading(true);

      try{
        const res = await fetch(`${API_BASE}/story/${encodeURIComponent(t)}?window_days=${encodeURIComponent(w)}`);
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        render(data);
      }catch(err){
        setLoading(false);
        showToast('Error: ' + (err.message || 'request failed'));
      }
    }

    function render(data){
      const f = data.facts || {};
      const s = data.story || {};
      setLoading(false);
      stage.innerHTML = `
        <article class="card">
          <h2 class="title">${escapeHtml(s.title || 'Stock Story')}</h2>
          <div class="meta">
            <strong>${escapeHtml(data.ticker || '')}</strong>
            &nbsp;•&nbsp; window: ${fmtNum(data.window_days || 0)}d
            &nbsp;•&nbsp; price: $${fmtNum(f.current_price)}
            &nbsp;•&nbsp; 1M: ${fmtNum(f.chg_1m)}% • 3M: ${fmtNum(f.chg_3m)}% • 1Y: ${fmtNum(f.chg_1y)}% • Vol(30d): ${fmtNum(f.vol_30)}
          </div>
          ${s.tldr ? `<p class="tldr"><strong>TL;DR:</strong> ${escapeHtml(s.tldr)}</p>` : ''}
          ${s.narrative ? `<p>${escapeHtml(s.narrative)}</p>` : ''}
          ${(s.positives && s.positives.length) ? `<div class="list"><h3>Positives</h3><ul>${s.positives.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`:''}
          ${(s.risks && s.risks.length) ? `<div class="list"><h3>Risks</h3><ul>${s.risks.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`:''}
          ${(s.suggested_tags && s.suggested_tags.length) ? `<div class="tags">${s.suggested_tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`:''}
          ${data.disclaimer ? `<p class="muted" style="margin-top:14px">${escapeHtml(data.disclaimer)}</p>`:''}
        </article>
      `;
    }

    $('#go').addEventListener('click', run);
    $('#ticker').addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });
    document.addEventListener('keydown', e=>{
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#ticker').focus(); }
    });

    (function init(){
      const url = new URL(location.href);
      const t = url.searchParams.get('t') || localStorage.getItem('last_ticker') || '';
      const w = url.searchParams.get('w') || '180';
      if(t) $('#ticker').value = t;
      $('#window').value = w;
      if(t) requestIdleCallback ? requestIdleCallback(run) : setTimeout(run, 50);
    })();
  </script>
</body>
</html>
