<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Stock Storyteller</title>
  <meta name="description" content="AI-generated trader briefs + market facts for any US ticker." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0d11;
      --panel:#0f1218;
      --muted:#9aa4af;
      --text:#e8ecf1;
      --brand:#74c0fc;
      --accent:#a78bfa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --ring: 0 0 0 2px rgba(167,139,250,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --glass: rgba(255,255,255,.06);
      --glass-border: 1px solid rgba(255,255,255,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(116,192,252,.08), transparent 40%),
                  radial-gradient(900px 700px at 110% 10%, rgba(167,139,250,.10), transparent 45%),
                  var(--bg);
      color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing:.1px;
    }
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:20px
    }
    .brand{
      display:flex;gap:12px;align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:
        radial-gradient(180px 80px at 80% -40%, rgba(167,139,250,.6), transparent 50%),
        radial-gradient(160px 120px at -20% 120%, rgba(116,192,252,.6), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.04));
      backdrop-filter: blur(6px);
      border:var(--glass-border);
      box-shadow:var(--shadow);
    }
    .title{font-weight:700;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}

    .panel{
      background:var(--glass); border:var(--glass-border);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .search{
      padding:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center
    }
    .field{flex:1;min-width:240px;position:relative}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], select{
      width:100%; padding:12px 14px; background:#0c0f14; color:var(--text);
      border:1px solid #1b2230; border-radius:12px; outline:none; font-size:14px;
      transition: box-shadow .15s, border-color .15s;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{
      border-color:#3b82f6; box-shadow: var(--ring);
    }
    .actions{display:flex;gap:12px;align-items:flex-end}
    button{
      padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(55,65,81,.6), rgba(30,41,59,.6));
      color:var(--text); font-weight:600; cursor:pointer; transition:.15s;
    }
    button:hover{transform:translateY(-1px)}
    button.primary{
      background:linear-gradient(180deg, #2563eb, #1d4ed8); border:none;
    }

    .suggestions{
      position:absolute; top:70px; left:0; right:0;
      background:#0c0f14; border:1px solid #1b2230; border-radius:12px; z-index:10;
      max-height:280px; overflow:auto; box-shadow:var(--shadow);
    }
    .suggestions div{
      padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px;
      border-bottom:1px solid rgba(255,255,255,.04);
    }
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#0f1520}
    .ticker{font-weight:700}
    .name{color:var(--muted);font-size:13px;text-overflow:ellipsis;white-space:nowrap;overflow:hidden}

    .grid{display:grid;grid-template-columns:1.2fr .8fr; gap:16px; margin-top:16px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{padding:16px}
    .card h3{margin:0 0 10px 0; font-size:16px}
    .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
    .kvs{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .kv{
      padding:10px 12px; background:#0c0f14; border:1px solid #1b2230; border-radius:12px; font-size:13px;
    }
    .kv b{display:block;color:#cbd5e1;font-size:12px;margin-bottom:4px;font-weight:600}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:#0c0f14; border:1px solid #1b2230; font-size:12px; color:#cbd5e1}
    .row{display:flex;flex-wrap:wrap;gap:8px}

    .loading{
      display:none; align-items:center; gap:8px; color:var(--muted); font-size:14px; padding:0 16px 16px 16px
    }
    .spinner{width:16px;height:16px;border:2px solid #3b82f6;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    footer{margin:26px 0 60px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">AI Stock Storyteller</div>
          <div class="sub">Trader-style briefs + market facts, on demand</div>
        </div>
      </div>
      <div class="sub">v2</div>
    </header>

    <section class="panel">
      <div class="search">
        <div class="field">
          <label for="ticker">Ticker</label>
          <input id="ticker" type="text" placeholder="AAPL, NVDA, MSFT…" autocomplete="off" />
          <div id="suggestions" class="suggestions" style="display:none;"></div>
        </div>
        <div class="field" style="max-width:220px">
          <label for="window">Lookback Window (days)</label>
          <select id="window">
            <option value="90">90</option>
            <option value="120">120</option>
            <option value="180" selected>180</option>
            <option value="270">270</option>
            <option value="365">365</option>
          </select>
        </div>
        <div class="actions">
          <button id="btnFetch" class="primary">Get Story</button>
          <button id="btnClear">Clear</button>
        </div>
      </div>
      <div id="loading" class="loading"><div class="spinner"></div>Fetching live data…</div>
    </section>

    <div class="grid">
      <section class="panel card">
        <h3 id="storyTitle">Story</h3>
        <div class="meta" id="storyMeta">—</div>
        <p id="storyTLDR" style="font-weight:600;margin:8px 0 12px 0;">—</p>
        <p id="storyText" style="line-height:1.6;color:#d6dee6;">—</p>

        <div style="margin-top:14px">
          <div class="sub" style="margin:8px 0 6px">Positives</div>
          <div id="positives" class="row"></div>
        </div>
        <div style="margin-top:12px">
          <div class="sub" style="margin:8px 0 6px">Risks</div>
          <div id="risks" class="row"></div>
        </div>
        <div style="margin-top:12px">
          <div class="sub" style="margin:8px 0 6px">Tags</div>
          <div id="tags" class="row"></div>
        </div>
      </section>

      <aside class="panel card">
        <h3>Key Facts</h3>
        <div id="facts" class="kvs">
          <!-- populated by JS -->
        </div>
      </aside>
    </div>

    <footer>© <span id="year"></span> Anirudh Kowshik — built with FastAPI + Lambda + API Gateway</footer>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://cq094tylu1.execute-api.us-west-2.amazonaws.com/Prod/api"; // from your stack output
    const TICKERS_URL = "./tickers.json"; // place tickers.json alongside this file in /docs

    // ====== UTIL ======
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, attrs={}, text="") => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => n.setAttribute(k,v));
      if (text) n.textContent = text;
      return n;
    };

    // ====== Autocomplete ======
    const txt = $("#ticker");
    const sug = $("#suggestions");
    let TICKERS = [];
    fetch(TICKERS_URL)
      .then(r => r.json())
      .then(list => { TICKERS = list; })
      .catch(() => { /* optional: silently ignore */ });

    function showSuggestions(q){
      if (!q || q.length < 1 || !TICKERS.length){ sug.style.display = "none"; return; }
      const needle = q.toUpperCase();
      const out = TICKERS.filter(t =>
        t.symbol.startsWith(needle) || (t.name && t.name.toUpperCase().includes(needle))
      ).slice(0, 12);

      if (!out.length){ sug.style.display = "none"; return; }
      sug.innerHTML = "";
      out.forEach(tk => {
        const row = el("div");
        const left = el("span", {class:"ticker"}, tk.symbol);
        const right = el("span", {class:"name"}, tk.name || "");
        row.append(left, right);
        row.addEventListener("click", () => {
          txt.value = tk.symbol;
          sug.style.display = "none";
        });
        sug.appendChild(row);
      });
      sug.style.display = "block";
    }
    txt.addEventListener("input", e => showSuggestions(e.target.value));
    document.addEventListener("click", (e) => {
      if (!sug.contains(e.target) && e.target !== txt) sug.style.display = "none";
    });

    // ====== Fetch + Render ======
    const loading = $("#loading");
    const windowSel = $("#window");
    const btnFetch = $("#btnFetch");
    const btnClear = $("#btnClear");

    const storyTitle = $("#storyTitle");
    const storyMeta = $("#storyMeta");
    const storyTLDR = $("#storyTLDR");
    const storyText = $("#storyText");
    const positives = $("#positives");
    const risks = $("#risks");
    const tags = $("#tags");
    const factsWrap = $("#facts");

    function fmtPct(x){
      if (x === null || x === undefined || isNaN(x)) return "—";
      return (x > 0 ? "+" : "") + x.toFixed(2) + "%";
    }
    function kv(label, value){
      const k = el("div", {class:"kv"});
      k.append(el("b", {}, label), el("div", {}, value));
      return k;
    }
    function badge(text){ return el("span", {class:"badge"}, text); }

    async function fetchStory(){
      const ticker = txt.value.trim().toUpperCase();
      const days = parseInt(windowSel.value, 10);
      if (!ticker){ alert("Enter a ticker (e.g., NVDA)"); txt.focus(); return; }

      loading.style.display = "flex";
      storyTitle.textContent = "Story";
      storyMeta.textContent = "—";
      storyTLDR.textContent = "—";
      storyText.textContent = "—";
      positives.innerHTML = risks.innerHTML = tags.innerHTML = "";
      factsWrap.innerHTML = "";

      try{
        const url = `${API_BASE}/story/${encodeURIComponent(ticker)}?window_days=${days}`;
        const res = await fetch(url, { method: "GET" });
        if (!res.ok){
          const msg = await res.text();
          throw new Error(msg || `HTTP ${res.status}`);
        }
        const data = await res.json();

        // Render Story
        storyTitle.textContent = data.story?.title || `${ticker} story`;
        storyMeta.textContent = `${data.ticker} · window ${data.window_days}d`;
        storyTLDR.textContent = data.story?.tldr || "—";
        storyText.textContent = data.story?.narrative || "—";

        (data.story?.positives || []).forEach(p => positives.appendChild(badge(p)));
        (data.story?.risks || []).forEach(r => risks.appendChild(badge(r)));
        (data.story?.suggested_tags || []).forEach(t => tags.appendChild(badge(t)));

        // Render Facts (curated order for traders)
        const f = data.facts || {};
        const items = [
          ["Price", f.current_price ? `$${(+f.current_price).toFixed(2)}` : "—"],
          ["5d / 1m / 3m", `${fmtPct(f.chg_5d)}  ·  ${fmtPct(f.chg_1m)}  ·  ${fmtPct(f.chg_3m)}`],
          ["6m / 1y", `${fmtPct(f.chg_6m)}  ·  ${fmtPct(f.chg_1y)}`],
          ["Vol (30d, ann.)", f.vol_30 ? fmtPct(f.vol_30) : "—"],
          ["Max DD (YTD)", f.max_dd_ytd ? fmtPct(f.max_dd_ytd) : "—"],
          ["RSI(14) / ATR(14)", `${f.rsi14?.toFixed?.(2) ?? "—"}  ·  ${f.atr14?.toFixed?.(2) ?? "—"}`],
          ["MAs", `${f.dma20?.toFixed?.(2) ?? "—"} / ${f.dma50?.toFixed?.(2) ?? "—"} / ${f.dma200?.toFixed?.(2) ?? "—"}`],
          ["Dist to 20/50/200", `${fmtPct(f.dist20_pct)} / ${fmtPct(f.dist50_pct)} / ${fmtPct(f.dist200_pct)}`],
          ["Slope20 (ann.)", f.slope20_pct_annual ? fmtPct(f.slope20_pct_annual) : "—"],
          ["Rel 3m vs SPY", f.rel_3m_vs_spy_pct ? fmtPct(f.rel_3m_vs_spy_pct) : "—"],
          ["Beta vs SPY", f.beta_vs_spy?.toFixed?.(2) ?? "—"],
          ["Vol ratio (1d/20d)", f.vol_ratio?.toFixed?.(2) ?? "—"],
          ["SR 20d Hi/Lo", (f.sr_high_20d && f.sr_low_20d) ? `$${f.sr_high_20d.toFixed(2)} / $${f.sr_low_20d.toFixed(2)}` : "—"],
          ["Technicals", f.technicals || "—"],
        ];
        items.forEach(([k,v]) => factsWrap.appendChild(kv(k,v)));

        // Remember last
        localStorage.setItem("lastTicker", ticker);
        localStorage.setItem("lastWindow", String(days));
      }catch(err){
        storyTitle.textContent = "Error";
        storyText.textContent = (""+err.message || "Failed to fetch story");
      }finally{
        loading.style.display = "none";
      }
    }

    btnFetch.addEventListener("click", fetchStory);
    btnClear.addEventListener("click", () => {
      txt.value = ""; sug.style.display = "none";
      storyTitle.textContent = "Story";
      storyMeta.textContent = storyTLDR.textContent = storyText.textContent = "—";
      positives.innerHTML = risks.innerHTML = tags.innerHTML = "";
      factsWrap.innerHTML = "";
    });

    // Enter key
    txt.addEventListener("keydown", (e) => {
      if (e.key === "Enter") fetchStory();
    });

    // Restore last state
    (function init(){
      $("#year").textContent = new Date().getFullYear();
      const lt = localStorage.getItem("lastTicker");
      const lw = localStorage.getItem("lastWindow");
      if (lt) txt.value = lt;
      if (lw) windowSel.value = lw;
    })();
  </script>
</body>
</html>
